name: Build Docker Images

permissions:
  actions: write
  contents: read
  packages: read
  security-events: write

on:
  push:
    branches:
      # NOTE: We build Docker images for the main branch and branches that are used for release validation.
      - main
      - cloud/*
      - feature/*
      - release/*
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      commit:
        description: "Commit sha"
        required: true

jobs:
  build-push-images:
    runs-on: ubuntu-latest-16-cores
    # Usually, a successful job takes ~17 mins.
    # Anything more than 30 mins is a sign that job is stuck.
    # This is a workaround until we find the root cause.
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: "true"
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.commit || '' }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set SHA when dispatched
        run: |
          SHA=$([ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ] && echo "${{ github.event.inputs.commit }}" || echo "${GITHUB_SHA}")
          echo "SHA=${SHA}" >> $GITHUB_ENV

      - name: Prepare build args
        id: build_args
        run: |
          # Generate SHA image tag
          github_sha_short=${GITHUB_SHA:0:7}
          echo "IMAGE_SHA_TAG=sha-${github_sha_short}" >> $GITHUB_ENV

          # Generate branch image tag
          branch_name=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
          echo "IMAGE_BRANCH_TAG=branch-${branch_name}" >> $GITHUB_ENV

          # Get submodule commit hashes
          TEMPORAL_SHA=$(git submodule status -- temporal | awk '{print $1}')
          echo "TEMPORAL_SHA=${TEMPORAL_SHA}" >> $GITHUB_ENV
          TCTL_SHA=$(git submodule status -- tctl | awk '{print $1}')
          echo "TCTL_SHA=${TCTL_SHA}" >> $GITHUB_ENV

          # Determine if we should tag as `latest`
          TAG_LATEST=${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') && 'true' || 'false' }}
          echo "TAG_LATEST=${TAG_LATEST}" >> $GITHUB_ENV

      - uses: actions/setup-go@v5
        with:
          cache-dependency-path: "**/*.sum"
          go-version-file: 'temporal/go.mod'

      # You can't use `load` when building a multiarch image, so we build and load the
      # native image locally for security scanning
      - name: Bake native images for security scanning
        run: make build-native

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Authenticate to GHCR
        env:
          PW: ${{ github.token }}
        run: echo "$PW" | oras login ghcr.io -u github-actions --password-stdin

      - name: Pull Trivy DBs from GHCR
        run: |
          mkdir -p $GITHUB_WORKSPACE/.cache/trivy/db
          oras pull ghcr.io/temporalio/trivy-db:2
          tar -xzf db.tar.gz -C $GITHUB_WORKSPACE/.cache/trivy/db
          rm db.tar.gz

          mkdir -p $GITHUB_WORKSPACE/.cache/trivy/java-db
          oras pull ghcr.io/temporalio/trivy-java-db:1
          tar -xzf javadb.tar.gz -C $GITHUB_WORKSPACE/.cache/trivy/java-db
          rm javadb.tar.gz

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.3
        with:
          version: v0.65.0

      - name: Run Grype zero-finding gate
        env:
          GRYPE_IMAGE: anchore/grype@sha256:0844db82d96f22b8010f361474d711b9eaf0f6438f853e75bfdb074094d41a20
          GRYPE_CHECK_FOR_APP_UPDATE: false
        run: make scan-grype

      - name: Run Trivy zero-finding gate
        env:
          TRIVY_SKIP_DB_UPDATE: true
          TRIVY_SKIP_JAVA_DB_UPDATE: true
          TRIVY_CACHE_DIR: ${{ github.workspace }}/.cache/trivy
        run: make scan-trivy

      - name: Collect scanner metadata
        if: always()
        run: |
          mkdir -p scan-results/meta

          trivy --version > scan-results/meta/trivy-version.txt
          cp "$GITHUB_WORKSPACE/.cache/trivy/db/metadata.json" scan-results/meta/trivy-db-metadata.json || true
          cp "$GITHUB_WORKSPACE/.cache/trivy/java-db/metadata.json" scan-results/meta/trivy-java-db-metadata.json || true

          echo "anchore/grype@sha256:0844db82d96f22b8010f361474d711b9eaf0f6438f853e75bfdb074094d41a20" > scan-results/meta/grype-image.txt
          docker run --rm anchore/grype@sha256:0844db82d96f22b8010f361474d711b9eaf0f6438f853e75bfdb074094d41a20 version > scan-results/meta/grype-version.txt
          docker run --rm anchore/grype@sha256:0844db82d96f22b8010f361474d711b9eaf0f6438f853e75bfdb074094d41a20 db status -o json > scan-results/meta/grype-db-status.json || true

      - name: Ensure images work
        run: make IMAGE_SHA_TAG=${{env.IMAGE_SHA_TAG}} test

      - name: Upload vulnerability scan artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-scan-results
          path: scan-results

      - name: Upload compose logs
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: docker-compose-logs
          path: docker-compose.log
